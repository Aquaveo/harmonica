stages:
  - mirror

variables:
  GITHUB_REPO_URL: "https://github.com/Aquaveo/harmonica.git"
  GITLAB_REPO_URL: "git@git.aquaveo.com:Aquaveo/model-executables/harmonica-mirror.git"
  GITHUB_ORG: "Aquaveo"
  GITHUB_REPO_NAME: "harmonica"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/pip-cache"
  PYTHON: C:\\Python36

mirror:
  stage: mirror
  image: centos:7
  script:
    # Notify GitHub that we are working on mirroring
    - curl -X POST -H "Content-Type:application/json" -H "Authorization:token $GITHUB_TOKEN" "https://api.github.com/repos/$GITHUB_ORG/$GITHUB_REPO_NAME/statuses/$CI_COMMIT_SHA" --data "{\"state\":\"pending\", \"target_url\":\"$CI_JOB_URL\", \"description\":\"Gitlab is working to mirror the commit\", \"context\":\"ci/git.aquaveo.com\"}"
      
    # Install needed tools
    - yum -y install openssh-clients git
    
    # Set up SSH
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${MIRROR_KEY}")   
    - mkdir -p ~/.ssh
    - echo "$SSH_HOSTKEYS" > ~/.ssh/known_hosts

    # Mirror the Repo
    - if [ -e github ]; then rm -rf github; fi
    - echo "Mirroring from ${GITHUB_REPO_URL}"
    - git clone --bare ${GITHUB_REPO_URL} github
    - cd github
    - git push --mirror ${GITLAB_REPO_URL}
    - cd ..
    - rm -rf github
  only: 
    - triggers

